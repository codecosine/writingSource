drcom折腾记
发表于 2016-11-07   |  
学校为了某种特殊的原因，更新了新的客户端drcom
催生了一波新的路由器破解风波。

由于我不在极路由的大众路由器系列，

K2的破解浪费了不少时间（其实就是自己鱼）

途中看了不少教程，只有一个感慨：写教程的时候，调侃的话语过多会影响阅读，把读者当傻逼，读者会感觉你其实也是瞎蒙的。我想起来高中的时候，教别人一道数学题，更多的是讲述题目的思路，让他自己去捕捉。说着说着又扯远了。其实我这篇也不是教程，因为写教程很累。只是自己记录一下，开心一下。

这次客户端是5.21P版drcom

主要原理是PPPOE拨号，然后不断发送心跳包请求来保持连接。

github上其他学校的dalao已经给出了Python的发送心跳包保持的脚本，这个脚本还在和恶势力持续不断的斗争更新。

我们要做的有2件事

1.PPPOE拨号
2.运行心跳包脚本
1.PPPOE拨号：

? 拨号的最终环境是路由器，但是由于路由器操作没有PC方便，我们先在PC进行测试

拨号成功的表现为：获取到正常的ip，正常上网但是每2分钟左右掉线一次

在Windows10上，需要使用PPPoE-Dialerwiki提供的拨号器

拨号需要账号和密码。

经过wireshark在正常客户端登录过程中的抓包测试

账号为：\r\n学号，密码为正常密码在路由器上

路由器正常的版本和内容都会带PPPOE拨号

这次的拨号，在openwrt系列路由器上（潘多拉等）固件上需要安装补丁

1
2
3
4
#!/bin/sh
cp /lib/netifd/proto/ppp.sh /lib/netifd/proto/ppp.sh_bak
sed -i '/proto_run_command/i username=`echo -e "$username"`' /lib/netifd/proto/ppp.sh
sed -i '/proto_run_command/i password=`echo -e "$password"`' /lib/netifd/proto/ppp.sh
这个补丁先在通过ssh连接路由器后运行，在通过luci登录才有效。

路由器无法拨号的原因：

如果你pc端拨号成功，但是路由器上无法拨号，恭喜你，我也不知道怎么办。

我折腾了很久，大概有这几个思路

首先这个补丁是必须的，但是你执行了之后还真不一定打上了。
非法的路由器mac地址可能会导致无法拨号（issue上指出的，我也不清楚什么算非法）
多拨几次。。。
2.运行心跳包脚本

脚本的环境为Python2.7

‘wiki’

pc端

安装完Python环境后，在拨号成功后，运行脚本，发送心跳包

观察网络是否正常

报错原因：

1.drcom正规客户端只是注销了没有关闭，占用了端口

2.由于Windows的换行符报错，这个需要用atom等现代编辑器修改一下

3.等等等等

贴上你的正规客户端的抓包和脚本运行的抓包去问DALAOhttps://github.com/drcoms/drcom-generic/issues

路由器

我一直没有搞清楚，为什么你们的路由器在弄校园网的时候可以上网。

后来我发现了，你们都是极路由，有现成的Python安装包下载

ipk安装包对不同的CPU和固件中，不一定能完全兼容

兼容的包只能在固件的源中找

libffi,python-mini

当然那些能上网的，就可以opkg update,opkg install

其次，还有一些固件是已经刷好了Python https://github.com/drcoms/drcom-generic/tree/master/openwrt

链接: https://pan.baidu.com/s/1qYaTTgC
密码:6sgp
配置完成py环境，在pc端测试通过的情况下，在路由器端当然也是可以正常运行的

由于我的路由器常年打开，我就不设置什么开机自动启动这种东西了。

如果需要这方面可以看广东工业大学路由器使用Dr.com校园网（OpenWRT，HIWifi通用）
其实我第一个看的就是这个贴，但是我看的头晕，真的。

1
2
3
4
5
6
7
8
9
10
sed -i '$d' /etc/rc.local
sed -i '$a sleep 15' /etc/rc.local
sed -i '$a 心跳脚本.sh' /etc/rc.local
sed -i '$a exit 0' /etc/rc.local
if [ "$ACTION" = ifup ]; then 
    if [ "${INTERFACE}" = "wan" ] || ["${INTERFACE}" = "pppoe-wan"]; then
        sleep 10 && python /usr/bin/drcom
    fi
fi
